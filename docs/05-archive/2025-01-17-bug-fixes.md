# Bug Fixes - January 17, 2025

## Finance Reports & Kitchen Dashboard Fixes

### Issues Resolved

#### 1. Revenue Report Discrepancies
**Problem**: Three finance reports showed different revenue totals:
- Popular items report: $304
- Summary statistics: $344.50
- Revenue by user: $290

**Root Causes**:
- Summary report included ALL payment statuses (PENDING, FAILED, COMPLETED, REFUNDED)
- Revenue by user excluded guest orders (had `userId: { not: null }` filter)
- Popular items correctly filtered to COMPLETED payments only

**Fix Applied**:
- Modified summary report to only count revenue from `COMPLETED` payments
- Removed `userId` filter from revenue by user query
- Added guest order handling to group by `guest_${email}` as userId

**Files Modified**:
- `backend/src/services/report.service.ts`:
  - Lines 66-156: Added guest order grouping in revenue by user
  - Lines 228-277: Modified summary to only sum COMPLETED payment revenue

**Result**: All three reports now consistently show revenue from COMPLETED payments only, and guest orders are properly included in revenue by user report.

---

#### 2. Deleted Items Appearing Multiple Times in Popular Items Report
**Problem**: "Beef Lasagna" (a deleted menu item) appeared on multiple separate lines instead of being grouped together.

**Root Cause**: Each order item was getting a unique ID `deleted_${item.id}`, creating separate entries for each instance of the same deleted item.

**Fix Applied**:
- Changed grouping logic from using `item.id` to using `itemName + itemCategory`
- Deleted items now grouped as `deleted_${itemName}_${itemCategory}`

**Files Modified**:
- `backend/src/services/report.service.ts` (lines 194-232)

**Code Change**:
```typescript
// Before:
const menuItemId = item.menuItemId || `deleted_${item.id}`;

// After:
if (item.menuItemId) {
  groupKey = item.menuItemId;
} else {
  const itemName = item.itemName || 'Deleted Item';
  const itemCategory = item.itemCategory || 'UNKNOWN';
  groupKey = `deleted_${itemName}_${itemCategory}`;
}
```

**Result**: All instances of the same deleted item (e.g., "Beef Lasagna") are now grouped together in the popular items report.

---

#### 3. Kitchen Dashboard Duplicate Key Warning
**Problem**: React warning "Each child in a list should have a unique 'key' prop" appeared when loading Kitchen Dashboard, especially when orders contained the same item with different variations.

**Root Cause**:
- Backend wasn't sending `orderItemId` in kitchen summary response
- Frontend was using `order.orderId` as React key, causing duplicates when same order had multiple items with same menuItemId
- Multiple items with different variations were being tracked by `menuItemId` instead of unique `orderItemId`

**Fix Applied**:

**Backend Changes** (`backend/src/services/kitchen.service.ts`):
- Line 130: Added `orderItemId: string` to TypeScript type definition
- Line 134: Added `selectedVariations: any` to type definition
- Line 159: Added `orderItemId: item.id` to the data being pushed

**Frontend Changes** (`frontend-admin/src/pages/KitchenDashboard.tsx`):
- Line 82: Added `orderItemId: string` to OrderSummary interface
- Line 616: Changed Grid key to `summary-${item.menuItem?.id || 'unknown'}-${itemIndex}`
- Lines 741-764: Fixed indentation and updated to use `orderItemId` for finding order items
- Line 764: Changed React key from `order.orderId` to `order.orderItemId`

**Result**: No more duplicate key warnings. Each order item (including variations) is now uniquely tracked and identified.

---

#### 4. Reports Page 403 Forbidden Error
**Problem**: When Finance users loaded the Reports page, they got error:
```
GET http://localhost:3000/api/v1/admin/locations 403 (Forbidden)
```

**Root Cause**: Reports page was trying to fetch from `/api/v1/admin/locations` which requires ADMIN role, but Finance role only has access to `/api/v1/finance/*` endpoints.

**Fix Applied**:
- Changed endpoint from `/api/v1/admin/locations` to `/api/v1/locations`
- The `/api/v1/locations` endpoint is public (no role restrictions) and returns active locations

**Files Modified**:
- `frontend-admin/src/pages/ReportsPage.tsx` (line 105)

**Code Change**:
```typescript
// Before:
const response = await axios.get(
  `${import.meta.env.VITE_API_URL}/admin/locations`,
  { headers: { Authorization: `Bearer ${token}` } }
);

// After:
const response = await axios.get(
  `${import.meta.env.VITE_API_URL}/locations`,
  { headers: { Authorization: `Bearer ${token}` } }
);
```

**Result**: Finance users can now successfully load the Reports page and filter by location.

---

## Technical Learnings

### Revenue Calculation Best Practices
- Always filter by `paymentStatus: 'COMPLETED'` when calculating revenue
- Include guest orders in revenue reports (don't filter by `userId: { not: null }`)
- Use `Order.totalAmount` for revenue (already includes all items, tax, fees)

### React Key Prop Requirements
- When mapping arrays with potentially duplicate IDs, use composite keys
- For items with variations, track by unique `orderItemId` not `menuItemId`
- Include index in key only as last resort (prefer unique identifiers)

### Role-Based Endpoint Access
- Public endpoints (`/api/v1/locations`): No authentication required, returns active items only
- User-specific endpoints (`/api/v1/locations/user/accessible`): Returns items accessible to authenticated user
- Admin endpoints (`/api/v1/admin/locations`): Requires ADMIN role, returns all items including inactive

### Deleted Item Handling
- Use snapshot fields (`itemName`, `itemCategory`, `itemBasePrice`) when menu item is deleted
- Group deleted items by semantic meaning (name + category) not by database ID
- Preserve historical data for reporting purposes

---

**Date**: January 17, 2025
**Files Changed**: 4 files total
- `backend/src/services/report.service.ts`
- `backend/src/services/kitchen.service.ts`
- `frontend-admin/src/pages/KitchenDashboard.tsx`
- `frontend-admin/src/pages/ReportsPage.tsx`

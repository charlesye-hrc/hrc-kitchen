generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String         @id @default(uuid())
  email                  String         @unique
  passwordHash           String?        @map("password_hash")
  fullName               String         @map("full_name")
  department             String?
  location               String?
  phone                  String?
  role                   UserRole       @default(STAFF)
  emailVerified          Boolean        @default(false) @map("email_verified")
  isActive               Boolean        @default(true) @map("is_active")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")
  lastSelectedLocationId String?        @map("last_selected_location_id")
  // Password reset token fields
  resetToken             String?        @map("reset_token")
  resetTokenExpiresAt    DateTime?      @map("reset_token_expires_at")
  // OTP authentication fields
  otpCode                String?        @map("otp_code")
  otpExpiresAt           DateTime?      @map("otp_expires_at")
  // User invitation fields
  invitedBy              String?        @map("invited_by")
  invitationToken        String?        @unique @map("invitation_token")
  invitationExpiresAt    DateTime?      @map("invitation_expires_at")
  invitedAt              DateTime?      @map("invited_at")
  orders                 Order[]
  configUpdates          SystemConfig[] @relation("ConfigUpdatedBy")
  userLocations          UserLocation[]
  lastSelectedLocation   Location?      @relation("UserLastLocation", fields: [lastSelectedLocationId], references: [id], onDelete: SetNull)
  inviter                User?          @relation("UserInvitations", fields: [invitedBy], references: [id], onDelete: SetNull)
  invitedUsers           User[]         @relation("UserInvitations")

  @@index([invitedBy])
  @@map("users")
}

model MenuItem {
  id                String                  @id @default(uuid())
  name              String
  description       String?
  price             Decimal                 @db.Decimal(10, 2)
  category          MenuCategory
  imageUrl          String?                 @map("image_url")
  dietaryTags       String[]                @default([]) @map("dietary_tags")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")
  weekdays          Weekday[]               @default([])
  customizations    MenuItemCustomization[]
  menuItemLocations MenuItemLocation[]
  orderItems        OrderItem[]
  variationGroups   VariationGroup[]

  @@map("menu_items")
}

model MenuItemCustomization {
  id                String   @id @default(uuid())
  menuItemId        String   @map("menu_item_id")
  customizationName String   @map("customization_name")
  createdAt         DateTime @default(now()) @map("created_at")
  menuItem          MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([menuItemId])
  @@map("menu_item_customizations")
}

model VariationGroup {
  id           String             @id @default(uuid())
  menuItemId   String             @map("menu_item_id")
  name         String
  type         VariationGroupType @default(SINGLE_SELECT)
  required     Boolean            @default(false)
  displayOrder Int                @default(0) @map("display_order")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  menuItem     MenuItem           @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  options      VariationOption[]

  @@index([menuItemId])
  @@map("variation_groups")
}

model VariationOption {
  id               String         @id @default(uuid())
  variationGroupId String         @map("variation_group_id")
  name             String
  priceModifier    Decimal        @default(0) @map("price_modifier") @db.Decimal(10, 2)
  isDefault        Boolean        @default(false) @map("is_default")
  displayOrder     Int            @default(0) @map("display_order")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  variationGroup   VariationGroup @relation(fields: [variationGroupId], references: [id], onDelete: Cascade)

  @@index([variationGroupId])
  @@map("variation_options")
}

model Order {
  id                String        @id @default(uuid())
  userId            String?       @map("user_id")
  orderNumber       String        @unique @map("order_number")
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10, 2)
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  paymentId         String?       @map("payment_id")
  fulfillmentStatus OrderStatus   @default(PLACED) @map("fulfillment_status")
  specialRequests   String?       @map("special_requests")
  orderDate         DateTime      @map("order_date") @db.Date
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  guestEmail        String?       @map("guest_email")
  guestFirstName    String?       @map("guest_first_name")
  guestLastName     String?       @map("guest_last_name")
  locationId        String?       @map("location_id")
  // Location snapshots - preserved even if location is deleted
  locationName      String?       @map("location_name")
  locationAddress   String?       @map("location_address")
  locationPhone     String?       @map("location_phone")
  // Customer snapshots - for registered users (guests use guestXxx fields)
  customerFullName  String?       @map("customer_full_name")
  customerEmail     String?       @map("customer_email")
  customerDepartment String?      @map("customer_department")
  orderItems        OrderItem[]
  location          Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  user              User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([locationId])
  @@index([guestEmail])
  @@index([orderDate])
  @@index([fulfillmentStatus])
  @@map("orders")
}

model OrderItem {
  id                 String       @id @default(uuid())
  orderId            String       @map("order_id")
  menuItemId         String?      @map("menu_item_id")
  quantity           Int          @default(1)
  customizations     Json?
  priceAtPurchase    Decimal      @map("price_at_purchase") @db.Decimal(10, 2)
  createdAt          DateTime     @default(now()) @map("created_at")
  selectedVariations Json?        @map("selected_variations")
  fulfillmentStatus  OrderStatus  @default(PLACED) @map("fulfillment_status")
  // MenuItem snapshots - preserved even if menu item is deleted
  itemName           String?      @map("item_name")
  itemDescription    String?      @map("item_description")
  itemCategory       MenuCategory? @map("item_category")
  itemImageUrl       String?      @map("item_image_url")
  itemBasePrice      Decimal?     @map("item_base_price") @db.Decimal(10, 2)
  menuItem           MenuItem?    @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  order              Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([menuItemId])
  @@map("order_items")
}

model SystemConfig {
  id          String   @id @default(uuid())
  configKey   String   @unique @map("config_key")
  configValue String   @map("config_value")
  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by")
  updater     User?    @relation("ConfigUpdatedBy", fields: [updatedBy], references: [id])

  @@map("system_config")
}

model Location {
  id                    String             @id @default(uuid())
  name                  String             @unique
  address               String?
  phone                 String?
  isActive              Boolean            @default(true) @map("is_active")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")
  menuItemLocations     MenuItemLocation[]
  orders                Order[]
  userLocations         UserLocation[]
  usersWithLastLocation User[]             @relation("UserLastLocation")

  @@index([isActive])
  @@map("locations")
}

model MenuItemLocation {
  id         String   @id @default(uuid())
  menuItemId String   @map("menu_item_id")
  locationId String   @map("location_id")
  createdAt  DateTime @default(now()) @map("created_at")
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, locationId])
  @@index([menuItemId])
  @@index([locationId])
  @@map("menu_item_locations")
}

model UserLocation {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  locationId String   @map("location_id")
  createdAt  DateTime @default(now()) @map("created_at")
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
  @@map("user_locations")
}

enum UserRole {
  STAFF
  KITCHEN
  ADMIN
  FINANCE
}

enum OrderStatus {
  PLACED
  PARTIALLY_FULFILLED
  FULFILLED
  PREPARING
  READY
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum MenuCategory {
  MAIN
  SIDE
  DRINK
  DESSERT
  OTHER
}

enum Weekday {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum VariationGroupType {
  SINGLE_SELECT
  MULTI_SELECT
}
